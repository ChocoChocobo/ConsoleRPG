#include <iostream>
#include <conio.h>
#include "casino.h"
#include "character.h"
#include "dice.h"

void SpecialEvent(Character& player) {
	int face = 5; // RollDice(5);
	bool input_choice = true;
	if (face == 5) {
		int PlayerChoice;
		cout << "Вы идёте по дороге, когда краем глаза замечаете движение в стороне." << endl;
		cout << "У старого костра, едва различимого сквозь сумерки, стоит человек." << endl;
		cout << "Закутанный в плащ странствующий торговец молча смотрит на вас —" << endl;
		cout << "а затем медленно поднимает руку и манит к себе, словно заранее зная, что вы его увидите." << endl << endl;
		cout << "Пламя костра на миг вспыхивает ярче, и вам кажется, что звон монет" << endl;
		cout << "доносится даже сквозь шум ветра..." << endl << endl;

		cout << "Вы останавливаетесь." << endl << "Незнакомец не произносит ни слова — лишь продолжает манить вас рукой," << endl << "будто решение уже принято за вас." << endl << endl << "Дорога зовёт вперёд, но костёр обещает тепло, золото и, возможно, удачу." << endl << "Вы чувствуете, как судьба на мгновение задерживает дыхание." << endl << endl;
			
			
			
			

		cout << "Ваше решение:" << endl;
		cout << "1. Подойти к торговцу" << endl;
		cout << "2. Пройти мимо, не оглядываясь" << endl;
		while (input_choice) {
			cin >> PlayerChoice;
			switch (PlayerChoice)
			{
			case 1:
				GameMoreLess(player, true);
				input_choice = false;
				break;
			case 2:
				GameMoreLess(player, false);
				input_choice = false;
				break;
			default:
				cout << "Выберите из единицы или двойки" << endl;
			}
			
		}
	}
	return;
}

void GameMoreLess(Character& player, bool GameReady) {
	system("cls");
	int PlayerChoice;
	bool input_choice = true;
	if (GameReady == true) {
		system("cls");
		cout << "Торговец медленно опускает руку и улыбается краем губ.\n"
			"— Я знал, что ты подойдёшь, путник. Такие, как ты, всегда чувствуют,\n"
			"когда удача проходит рядом.\n\n"
			"Он придвигает к костру потёртую кожаную чашку и тихо звякает монетами.\n"
			"— Дорога утомляет, а судьба любит тех, кто готов рискнуть.\n"
			"У меня есть простая игра… три кости. Я бросаю их —\n"
			"а ты решаешь, будет ли следующий бросок больше или меньше.\n\n"
			"Ну что? Испытаем фортуну?\n\n";
		
		cout << "Сыграете?\n";
		cout << "1. Давай\n";
		cout << "2. Не хочу рисковать\n";
		while (input_choice) {
			cin >> PlayerChoice;
			switch (PlayerChoice)
			{
			case 1:
				input_choice = false;
				RoundGame(player, GameReady);
				break;
			case 2:
				input_choice = false;
				cout << "Вы качаете головой и делаете шаг назад от костра.\n\n"
					"Улыбка медленно сходит с лица торговца.\n"
					"— Осторожность… — протягивает он, перекатывая слово на языке. — Тоже выбор.\n\n"
					"Он пожимает плечами и сгребает чашку с костями ближе к себе.\n"
					"Монеты в его кармане звякают глухо, будто неохотно.\n\n"
					"— Иди своей дорогой, путник. Удача не любит, когда её заставляют ждать.\n\n"
					"Вы отходите от костра, и свет пламени быстро тускнеет за вашей спиной.\n"
					"Когда вы оборачиваетесь в последний раз — торговец уже смотрит в огонь,\n"
					"словно вас здесь никогда и не было.\n";
				break;
			default:
				cout << "Выберите из единицы или двойки" << endl;
			}
		}
	}
	else if (GameReady == false) {
		system("cls");
		cout << "Вы отводите взгляд и продолжаете идти, не сбавляя шага.\n"
			"За спиной остаётся потрескивание костра, и только на мгновение\n"
			"вам кажется, что чужой взгляд всё ещё сверлит вашу спину.\n\n"
			"Вы не слышите шагов — торговец не идёт следом.\n"
			"Лишь ветер доносит глухой звон, похожий на стук монет,\n"
			"хотя вы так и не уверены, был ли он на самом деле.\n\n"
			"Дорога постепенно уводит вас во тьму,\n"
			"а костёр и его хозяин растворяются за очередным поворотом.\n\n"
			"Иногда самый безопасный выбор — пройти мимо.\n"
			"Иногда — самый тяжёлый.\n\n";
	}
	cout << "Нажмите любую клавишу, чтобы продолжить...";
	_getch(); // Ждет нажатия одной клавиши
	system("cls");
	return;
}

void RoundGame(Character& player, bool GameReady) {
	system("cls");
	while (GameReady == true) {
		int ResultOfDice = 0;
		int PlayerChoice;
		bool More = true;
		bool Money = true;
		int PlayerBet;

		cout << "Торговец молча придвигает к вам потёртую кожаную чашку.\n"
			"Он легко встряхивает её, и внутри глухо перекатываются кости.\n\n"
			"— Фортуна не считает попытки, путник, — говорит он негромко. —\n"
			"Она лишь смотрит, готов ли ты поставить что-то взамен.\n\n"
			"Торговец наклоняется ближе к огню.\n"
			"— Назови свою ставку. Сколько золотых ты готов доверить этому броску?\n\n";

		cout << "(Ваш кошелек: " << player.gold << " золотых)" << endl << endl;

		while (Money) {
			cout << "Введите вашу ставку: ";
			cin >> PlayerBet;
			if (PlayerBet > player.gold || PlayerBet < 1) {
				cout << endl << "Поставьте на кон столько, сколько есть в кошельке" << endl;
				continue;
			}
			else {
				Money = false;
			}
		}

		for (int i = 0; i < 3; i++) {
			int dice = RollDice(20);
			ResultOfDice += dice;
			cout << dice << ", ";
		}
		system("cls");
		cout << "Торговец бросает взгляд на выпавшие кости и криво усмехается.\n"
			"— Вот что решила судьба на этот раз… " << ResultOfDice << ".\n\n"
			"Он медленно стучит пальцем по чашке.\n"
			"— Теперь твой черёд гадать, путник.\n"
			"Следующий бросок будет выше этой цифры… или ниже?\n\n"
			"Выбирай.\n\n";


		bool input_choice = true;
		while (input_choice) {
			cout << "Ваш выбор:\n";
			cout << "1. Больше\n";
			cout << "2. Меньше\n";
			cin >> PlayerChoice;
			switch (PlayerChoice)
			{
			case 1:
				input_choice = false;
				cout << "Торговец медленно кивает.\n"
					"— Значит, выше.\n\n";
				break;
			case 2:
				input_choice = false;
				cout << "Торговец прищуривается и чуть наклоняет голову.\n"
					"— Значит, ниже.\n\n";
				More = false;
				break;

			default:
				cout << "Выберите из единицы или двойки" << endl;
			}
		}
		cout << "Нажмите любую клавишу, чтобы продолжить...";
		_getch(); // Ждет нажатия одной клавиши
		system("cls");

		cout << "Вы ставите свою монету на чашку. Торговец сжимает кости в кулаке,\n"
			"медленно встряхивает их и с глухим стуком выпускает на деревянную доску...\n\n"
			"Кости перекатываются, скрипят о дерево, и за мгновение судьба раскрывает свою сумму: ";
		int GameDice = ResultOfDice;
		ResultOfDice = 0;

		for (int i = 0; i < 3; i++) {
			int dice = RollDice(20);
			ResultOfDice += dice;
		}

		cout << ResultOfDice << "!\n\n";

		// 1. УСЛОВИЯ ПОБЕДЫ
		// (Ставил на БОЛЬШЕ и выпало БОЛЬШЕ) ИЛИ (Ставил на МЕНЬШЕ и выпало МЕНЬШЕ)
		if ((More == 1 && GameDice < ResultOfDice) || (More == 0 && GameDice > ResultOfDice)) {
			cout << "Торговец слегка морщится, едва заметно кивает и протягивает вам монеты.\n"
				"— Вот видишь, фортуна улыбается смелым. Твой выигрыш — твой.\n\n";
			player.AddGold(PlayerBet);
		}

		// 2. УСЛОВИЯ ПРОИГРЫША
		// (Ставил на БОЛЬШЕ, а выпало МЕНЬШЕ) ИЛИ (Ставил на МЕНЬШЕ, а выпало БОЛЬШЕ)
		else if ((More == 1 && GameDice > ResultOfDice) || (More == 0 && GameDice < ResultOfDice)) {
			cout << "Торговец ловко сжимает кости и забирает вашу ставку.\n"
				"— Судьба благоволит не всегда. В этот раз фортуна была не на твоей стороне.\n\n";
			player.RemoveGold(PlayerBet);
		}
		else if (GameDice == ResultOfDice) {
			cout << "Кости показали ту же сумму, что и в первый раз — судьба не желает определять победителя.\n"
				"Торговец наклоняется к чашке, глухо вздыхает и слегка пожимает плечами.\n"
				"— Ровно " << ResultOfDice << ", — говорит он тихо. — Никто не выигрывает, никому не проигрывает.\n"
				"Твои деньги остаются при тебе.\n\n";
			cout << "Перебросим?\n";
			cout << "1. Давай\n";
			cout << "2. Не-а\n";
			input_choice = true;
			while (input_choice) {
				cin >> PlayerChoice;
				system("cls");
				switch (PlayerChoice)
				{
				case 1:
					input_choice = false;
					RoundGame(player, GameReady);
					break;
				case 2:
					input_choice = false;
					GameReady = false;
					GameMoreLess(player, GameReady);
					break;
				default:
					cout << "Выберите из единицы или двойки" << endl;
				}
			}
		}

		cout << "Торговец ловко подхватывает кубики с дерева и снова прячет их в кулак.\n"
			"Он коротко кивает, словно оценивая твою решимость.\n"
			"— Судьба любит тех, кто готов пытаться снова, — говорит он спокойно.\n\n"
			"Ну что, путник, бросим кости ещё раз или на сегодня хватит?\n";
		cout << "1. Давай" << endl << "2. Не-а" << endl;
		input_choice = true;
		while (input_choice) {
			cin >> PlayerChoice;
			system("cls");
			switch (PlayerChoice)
			{
			case 1:
				input_choice = false;
				RoundGame(player, GameReady);
				break;
			case 2:
				input_choice = false;
				cout << "Вы качаете головой и делаете шаг назад от костра.\n\n"
					"Улыбка медленно сходит с лица торговца.\n"
					"— Осторожность… — протягивает он, перекатывая слово на языке. — Тоже выбор.\n\n"
					"Он пожимает плечами и сгребает чашку с костями ближе к себе.\n"
					"Монеты в его кармане звякают глухо, будто неохотно.\n\n"
					"— Иди своей дорогой, путник. Удача не любит, когда её заставляют ждать.\n\n"
					"Вы отходите от костра, и свет пламени быстро тускнеет за вашей спиной.\n"
					"Когда вы оборачиваетесь в последний раз — торговец уже смотрит в огонь,\n"
					"словно вас здесь никогда и не было.\n";
				return;
				break;
			default:
				cout << "Выберите из единицы или двойки" << endl;
			}
		}
	}
}
